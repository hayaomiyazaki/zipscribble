<!DOCTYPE html>
<html>
<head>
	<style type="text/css">
	path.zipline {
		stroke: black;
		stroke-width: .5px;
		fill: none;
	}
	</style>
	<script type="text/javascript" src="d3.v3.min.js"></script>
	<script type="text/javascript" src="interpolate-zoom.js" charset="utf-8"></script>
	<script type="text/javascript">
		var zips;

		var width = 960;
		var height = 500;

		var currentView = [width/2, height/2, height];
		var center = [width/2, height/2];
		var isZooming = false;

		var svg;
		var path;

		var scribbleGroup;

		var numZIPs = 2;
		var delay = 0;

		var currentPath = null;

		var boundingBox = {minX: Number.POSITIVE_INFINITY, minY: Number.POSITIVE_INFINITY, maxX: -1, maxY: -1};

		function tick() {
			if (currentPath && numZIPs % 100 != 0)
				currentPath.remove();

			currentPath = scribbleGroup.append('path')
				.datum(zips.slice(Math.max(0, Math.floor(numZIPs/100)*100-1), numZIPs))
				.attr('class', 'zipline')
				.attr('d', path);

			addToBoundingBox(zips[numZIPs]);

			if (numZIPs % 100 == 0 && !isZooming)
				zoomPanTo(boundingBox);

			numZIPs += 1;
			if (numZIPs < zips.length) {
				setTimeout(tick, delay);
			}
		}

		function addToBoundingBox(zip) {
			boundingBox.minX = Math.min(boundingBox.minX, zip.x);
			boundingBox.maxX = Math.max(boundingBox.maxX, zip.x);
			boundingBox.minY = Math.min(boundingBox.minY, zip.y);
			boundingBox.maxY = Math.max(boundingBox.maxY, zip.y);
		}

		function transform(p) {
			var k = height / p[2];
			return 'translate('+(center[0]-p[0]*k)+','+(center[1]-p[1]*k)+')scale('+k+')';
		}

		function zoomPanTo(bbox) {

			var newView = [(bbox.minX+bbox.maxX)/2, (bbox.minY+bbox.maxY)/2, bbox.maxY-bbox.minY];

			var interpolator = d3.interpolateZoom(currentView, newView);

			isZooming = true;

			scribbleGroup.attr('transform', transform(currentView))
				.transition()
					.delay(250)
					.duration(interpolator.duration)
					.attrTween('transform', function() { return function(t) { return transform(interpolator(t)); }; })
					.each('end', function() {
						currentView = newView.slice(0); // copy
						isZooming = false;
					// 	if (nextStep)
					// 		nextStep();
					});
		}


		function pause() {
			numZIPs = zips.length;
		}

		d3.csv('data/US-withheaders.csv', function(data) {
			data.sort(function(a, b) {
				return a.zip - b.zip;
			});
			zips = data;

			var projection = d3.geo.albersUsa()
				.scale(1000)
				.translate([width / 2, height / 2]);

			zips.forEach(function(z) {
				var p = projection([z.lon, z.lat]);
				if (p) {
					z.x = p[0];
					z.y = p[1];
				} else {
					z.x = z.y = -1;
				}
			})

			zips = zips.filter(function(z) {
				return z.x != -1;
			});

			for (var i = 0; i < numZIPs; i += 1) {
				addToBoundingBox(zips[i]);
			}

			path = d3.svg.line()
				.x(function(z) { return z.x; })
				.y(function(z) { return z.y; });

			svg = d3.select('#map').append('svg')
				.attr('width', width)
				.attr('height', height);

			scribbleGroup = svg.append('g');

			tick();
			});
	</script>
</head>
<body>
	<div id="map">
	</div>
	<label><input type="checkbox" id="pause" onclick="pause();"/> Pause</label>
</body>
</html>